name: Update apt repository

on:
  workflow_run:
    workflows: ["Publish to npm & Build Desktop"]
    types: [completed]

jobs:
  update-apt-repo:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: echo "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Get release tag
        id: tag
        env:
          RUN_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          VERSION="${RUN_HEAD_BRANCH#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$RUN_HEAD_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Export public key
        run: gpg --armor --export > website/gpg.key

      - name: Generate install script
        run: |
          cat > website/install.sh << 'SCRIPT_EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          REPO="elleryfamilia/brosh"
          GPG_KEY_URL="https://bro.sh/gpg.key"

          # Detect architecture
          ARCH=$(dpkg --print-architecture 2>/dev/null || uname -m)
          case "$ARCH" in
            amd64|x86_64) ARCH="amd64" ;;
            arm64|aarch64) ARCH="arm64" ;;
            *) echo "Error: unsupported architecture: $ARCH"; exit 1 ;;
          esac

          # Determine version (use argument, or fetch latest)
          if [ -n "${1:-}" ]; then
            VERSION="$1"
          else
            VERSION=$(curl -fsSL "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name"' | head -1 | cut -d'"' -f4 | sed 's/^v//')
          fi

          DEB_URL="https://github.com/$REPO/releases/download/v${VERSION}/brosh-desktop_${VERSION}_${ARCH}.deb"
          TMP_DEB=$(mktemp /tmp/brosh-XXXXXX.deb)

          echo "Installing brosh v${VERSION} for ${ARCH}..."

          # Download
          curl -fSL "$DEB_URL" -o "$TMP_DEB"

          # Verify GPG signature if key is available
          if command -v gpg >/dev/null 2>&1; then
            curl -fsSL "$GPG_KEY_URL" | gpg --import --batch 2>/dev/null || true
          fi

          # Install
          if command -v apt >/dev/null 2>&1; then
            sudo apt install -y "$TMP_DEB"
          else
            sudo dpkg -i "$TMP_DEB" || sudo apt-get install -f -y
          fi

          rm -f "$TMP_DEB"
          echo "brosh v${VERSION} installed successfully."
          SCRIPT_EOF
          chmod +x website/install.sh

      - name: Generate uninstall script
        run: |
          cat > website/uninstall.sh << 'SCRIPT_EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          echo "Removing brosh..."
          sudo apt remove -y brosh-desktop 2>/dev/null || sudo dpkg -r brosh-desktop 2>/dev/null || true
          echo "brosh removed."
          SCRIPT_EOF
          chmod +x website/uninstall.sh

      - name: Sign install script
        run: gpg --batch --yes --armor --detach-sign -o website/install.sh.asc website/install.sh

      - name: Commit and push
        env:
          RELEASE_VERSION: ${{ steps.tag.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add website/install.sh website/uninstall.sh website/gpg.key website/install.sh.asc
          git commit -m "Update install scripts for v$RELEASE_VERSION" || echo "No changes"
          git push origin main
